## 🎯 Overview

- This is a REST API Server under project `XDATA-AI-OCR`.  
- The API server is developed based on Python [`FastAPI`](https://fastapi.tiangolo.com/) and [`swivel-common`](https://github.com/swivelsoftware/lib-py-common)
- The API provides OCR services for `pdf-text`, `pdf-image` and `image`.
  > `pdf-text` refers to pdf with clean/accurate text info.  
  > `pdf-image` refers to pdf with embedded images.  
  > `image` refers to standard jpg or png images
- The server provides API docs in Swagger format, which is auto generated by endpoints and data models.


## 🚀 API designed for CPU Intensive tasks

Since the API processes OCR tasks which are CPU intensive tasks by nature, the API server must be properly designed for a few objectives

1. Request concurrency  
   Able to process multiple concurrent requests without hanging.
1. Server resources control  
   RAM/CPU resources should be properly controlled to avoid system panic and crash.
1. Request overload  
   In case of server overload, requests should be rejected earlier instead of hanging.
1. Timeout  
   Request should be notified if the response is not returning timely.
1. Scale out  
   Multiple instances of servers can be deployed to production environment to increase processing capacity of the OCR services.

## 🔤 OCR Engines

- For `pdf-text` (pdf with text)
  - [pdfplumber](https://github.com/jsvine/pdfplumber)
    This is a text extraction library for `pdf-text`.
- For `pdf-image` (pdf with embedded image)
  - [PaddleOCR](https://github.com/PaddlePaddle/PaddleOCR)  
    This is an offline, self-hosted OCR library for `pdf-image` and `image`
  - Google Vision AI  
    This is a Google online AI service for a wide range of vision application, e.g. OCR on `image`
    - Product: https://cloud.google.com/vision
    - Doc - https://cloud.google.com/vision/docs
    - Pricing - https://cloud.google.com/vision/pricing

# 💻 Environment

- Language: Python `3.11.8`
- Virtualenv - Windows
  > NOTE: Target Python version should be installed on Windows
  ```bat
  :: Create an folder winEnv where packages are installed
  py -3.11 -m venv winEnv
  :: Activate virtualenv
  winEnv\Scripts\activate
  ```
- Virtualenv - Linux/Ubuntu
  > NOTE: pyenv should be installed on Ubuntu. For details, Refer to [pyenv repo](https://github.com/pyenv/pyenv).
  ```bash
  ## Update pyenv
  pyenv update
  ## Install Python 3.11.8
  pyenv install 3.11.8
  ## Create virtualenv
  pyenv virtualenv 3.11.8 xdata-aicor-engine-api
  ## Activate virtualenv
  pyenv activate xdata-aicor-engine-api
  ```
## 📲 Install package and `swivel-common`
- The API servers depends on `swivel-common` package which is hosted on GitHub repo as a private package.  
  For details setting up read permission on the `swivel-common` package, please refer to [README](https://github.com/swivelsoftware/lib-py-common#-repo-permission-and-deploy-key) of repo [lib-py-common](https://github.com/swivelsoftware/lib-py-common)
- Install packages by `pip install -r requirements.txt`
  > NOTE: Always install packages on virtualenv!!

## ➡️ Reverse Proxy to the API server 
- For development/staging setup, the API server has the environment
  - Runs and binds on local TCP port, e.g. 8000
  - Uses HTTPS protocol with a development and SSL certificate.  
    > NOTE: [LetsEncrypt](https://letsencrypt.org/) issues free but short-lived SSL certificate that it has to renew every 3 months.  Thus, it can be used for dev and test purpose.
  - If API server runs on HTTP, web app running on browser, e.g. Chrome, may refuse to connect to the API server because HTTP is considered insecure.
- For UAT/production, the API server has the environment
  - A public-facing front web server, e.g. nginx, IIS with ARR, is configured to reverse proxy to the backend API server.
  - A commercial grade SSL certificate is deployed to the web server.  
    > NOTE: Most commercial SSL certificate with life-span in years instead of months.
  - Runs and binds on local TCP port, e.g. 8000, and use HTTP instead of HTTPS
  - When a web app sends API request, it will be served using the web server with HTTPS and the request will be routed to the backend API server.

## 🔒 API Access Security
- Only authorized access is permitted to use the API server.  
  It utilizes industry standard JWT token for authorization check.
- The JWT has a payload in Swivel JwtV3 standard.  
  For details, please refer to [README](https://github.com/swivelsoftware/lib-cs-common#swivel-auth-jwt-token-v3) of repo [lib-cs-common](https://github.com/swivelsoftware/lib-cs-common)
- All http/https requests all first examined by JwtV3 middleware.  
- The middleware will validate the jwt token carried by the HTTP Authorization header, and pass the request downstream to the designated endpoint.
- If the token is invalid, middleware simply returns 401.
## ▶️ How to run

- First, always activate the virtualenv before running the API server.
- Run the `main.py` by `python src\main.py`
  > NOTE: `main.py` is designed to run on the project root directory, i.e. the parent directory of this directory where the py file is resided.

## Vscode extensions

Recommended vscode extensions

- Python and Pylance  
  `ext install ms-python.python`  
  `ext install ms-python.vscode-pylance`
- Black Formatter  
  `ext install ms-python.black-formatter`
- Git Graphs  
  `ext install mhutchie.git-graph`
- Code Spell Checker  
  `ext install streetsidesoftware.code-spell-checker`
- REST Client  
  `ext install humao.rest-client` 

## Git Branches

- Branch `main`
  - `main` branch is a long-running branch that contains well-tested code ready for production use.
  - Production releases are indicated by release tags, e.g. `v1.0.1`
- Branch `develop`
  - `develop` branch is a long-running branch that is constantly updated through merges:
    - From `issue` branches for bug fixings.
    - From `topic` branches for enhanced features or enhancements.
  - When `develop` branch reaches a stable state, it will be merged into the `main` branch.
  - As a result, the `develop` branch is typically ahead of `main` branch.
- Branch `issue` and `topic`
  - `issue` and `topic` branches are short-lived compared to `main` and `develop` branches.
  - `issue` branches are primarily used for bug fixes and are considered short-lived. They are merged into the `develop` branch once the fix is complete.
  - `topic` branches can represent ongoing development for features and may be longer-lived.
    However, some `topic` branches may be short-lived for experimental features that could be discarded later.
  - When `issue` and `topic` branches are merged to `develop` branches, they will be removed in most cases.


## Technical Challenges
There are a few technical challenges of this repo.
1. [asyncio, multi-threading and multi-processing](./doc/asyncio.md)
2. PaddleOCR  
   https://github.com/PaddlePaddle/PaddleOCR
